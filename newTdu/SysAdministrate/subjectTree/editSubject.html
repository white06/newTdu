<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

</head>
<!--<link type="text/css" href="style.css" rel="stylesheet"/>-->
<link rel="stylesheet" href="../../js/layui/css/layui.css">
<!--<link href="../../model/Css.css" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="../../model/MyCss.css"/>
<link rel="stylesheet" href="../../model/page.css"/>-->
<script src="../../js/layui/layui.js"></script>
<script src="../../js/custom/jquery-3.5.1.js"></script>
<script src="../../js/api.js"></script>

<script>
    var index = parent.layer.getFrameIndex(window.name);
    var subid1 = parent.layer.subid;
    var lei1 = parent.layer.lei;
    $(document).ready(function () {
        var str = GetRequest();
        eval(str)
        subid1 = str.subid
        lei1 = str.lei
        console.log(subid1, lei1)

    })

    function GetRequest() {
        var url = location.search; //获取url中"?"符后的字串
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for (var i = 0; i < strs.length; i++) {
                theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
            }
        }
        return theRequest;
    }
</script>
<style>
    .layui-table[lay-skin=row] {
        border-top: 2px solid #2E3546;
        border-width: 2px;
        border-style: solid;
        border-color: #2E3546;
    }

    .layui-table {
        background: #3C4154;
        color: white;
    }

    .layui-table thead tr {
        background: #3C4154;
        color: white;
        border: 2px solid #2E3546;
    }

    .layui-table[lay-even] tr:nth-child(2n) {
        background: #3C4154;
        border: 2px solid #2E3546;
    }

    .layui-table th {
        border-color: #2E3546;
    }

    .layui-table[lay-even] tr:nth-child(n) {
        border-color: #2E3546;
    }

    .layui-input {
        border-color: #3C4154;
    }

    .layui-input {
        background: #3C4154;
        color: white;
    }

    .layui-form-select dl {
        border: 1px solid #3C4154;
        background-color: #3C4154;
        padding: 0;
    }
    .layui-input:hover, .layui-textarea:hover {
        color: white;
        border-color: #3C4154 !important
    }

    .layui-input:focus, .layui-textarea:focus {
        color: white;
        border-color: #3C4154 !important
    }
</style>

<div id="addNew" style="margin:0 2%;width: 96%;" class="form">
    <div>
        <div class="layui-card" style="padding-top: 20px;">
            <div class="layui-card-body">

                <table class="layui-table" lay-even="" lay-skin="row">
                    <colgroup>
                        <col width="auto">
                        <col width="auto">
                        <col width="auto">
                        <col>
                    </colgroup>
                    <thead>
                    <tr>
                        <th>项目名称</th>
                        <th>picture</th>
                        <th>样式</th>
                        <th>状态</th>
                        <th>icon</th>
                    </tr>
                    </thead>
                    <tbody id="test3">
                    <tr>
                        <td>
                            <div class="layui-form">
                            <div class="layui-form-item">
                            <div class="layui-input-block" style="margin-left: 0px;">
                                <input value="闲心" type="text" name="title" lay-verify="title" autocomplete="off"  class="layui-input">
                            </div>
                        </div>
                            </div>
                        </td>
                       <!-- <td>
                            <div class="layui-form">
                                <div class="layui-form-item">
                                    <input type="file" id="fileupload" multiple class="btn btn-default" onchange="changefile()"  name="fileupload" style="display:none" />
                                    <div class="layui-input-block" style="margin-left: 0px;">
                                        <input type="text" id="brosweFile" class="btn btn-default" readonly style="width:50%" />
                                        <input type="button" class="layui-btn layui-btn-danger" onclick="$('#fileupload').click()" value="浏览" id="brosweevent" />
                                    </div>
                                </div>
                            </div>
                        </td>-->


                        <td>

                        </td>
                        <td>
                            <div class="layui-form">
                                <div class="layui-form-item">
                                    <div class="layui-input-block" style="margin-left: 0px;">
                                        <select name="interest" lay-filter="aihao">
                                            <option value="0">禁用</option>
                                            <option value="1">启用</option>
                                        </select>
                                    </div>
                                </div>
                            </div>


                            <!--<div class="layui-form">
                                <div class="layui-form-item">
                                    <div class="layui-input-block" style="margin-left: 0px;">
                                        <select name="interest" lay-filter="aihao">
                                        <option value="0">禁用</option>
                                        <option value="1" selected="selected">启用</option>
                                    </select>
                                    </div>
                                </div>
                            </div>-->


                        </td>
                    </tr>
                    </tbody>

                </table>
                <div id="test-laypage-demo20"></div>
            </div>
        </div>
    </div>

    <div style="display: inline-block;text-align:center;margin: 0 12.5%;width: 25%;margin-top: 40px;margin-bottom: 20px;
height:40px;
background:linear-gradient(337deg,rgba(92,205,177,1) 0%,rgba(92,205,178,1) 0%,rgba(89,208,207,1) 100%);
border-radius:5px;">
        <a style="height:28px;
font-size:20px;
font-family:PingFangSC-Regular,PingFang SC;
font-weight:400;
color:rgba(255,255,255,1);
line-height:40px;" class="add-btn ulib-r3" href="javascript:"
           onclick="submitTree()">保存</a>
    </div>


    <div style="display: inline-block;text-align:center;margin: 0 auto;width: 25%;margin-top: 40px;margin-bottom: 20px;
height:40px;
background:linear-gradient(337deg,rgba(92,205,177,1) 0%,rgba(92,205,178,1) 0%,rgba(89,208,207,1) 100%);
border-radius:5px;">
        <a style="height:28px;
font-size:20px;
font-family:PingFangSC-Regular,PingFang SC;
font-weight:400;
color:rgba(255,255,255,1);
line-height:40px;" class="add-btn ulib-r3" href="javascript:" onclick="back()">返回</a>
    </div>
</div>
<script>





    var subjectKey = "ff75ffcf-8aca-4e0f-874c-70d20f21ade0";

    var index = parent.layer.getFrameIndex(window.name);
    var treeid = parent.layer.treeid;
    $(document).ready(function () {
        var str = GetRequest();
        eval(str)
        treeid = str.treeid

    })

    function back() {
        window.parent.location.reload();
        var index1 = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index1);
    }
    function GetRequest() {
        var url = location.search; //获取url中"?"符后的字串
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for (var i = 0; i < strs.length; i++) {
                theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
            }
        }
        return theRequest;
    }

    function getWebRootPath () {
        var a = window.document.location.href;//
        var b = window.document.location.pathname;
        var pos = a.indexOf(b);
        var path = a.substring(0, pos);
        a = a.substring(a.indexOf("/") + 2, a.length);
        a = a.substring(a.indexOf("/") + 1, a.length);
        var pathName = a.substring(0, a.indexOf("/"));
        return path + "/" + pathName;
    }

    var iconName="";

    layui.use(['laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element','form'], function () {
        var laydate = layui.laydate //日期
            , laypage = layui.laypage //分页
            , layer = layui.layer //弹层
            , table = layui.table //表格
            , carousel = layui.carousel //轮播
            , upload = layui.upload //上传
            , element = layui.element //元素操作
            , form = layui.form;



        //监听工具条
        table.on('tool(test-table-operate)', function (obj) {
            var data = obj.data;
            if (obj.event === 'detail') {
                layer.msg('ID：' + data.id + ' 的查看操作');
            } else if (obj.event === 'del') {
                layer.confirm('真的删除行么', function (index) {
                    obj.del();
                    layer.close(index);
                });
            } else if (obj.event === 'edit') {
                layer.alert('编辑行：<br>' + JSON.stringify(data))
            }
        });


        //将一段数组分页展示

        //测试数据
        var testLayPageData = [
            '北京',
            '上海',
            '广州'
        ];

        var stra=getWebRootPath();


        $.ajax({
            type: "POST",
            url: houtaiurl + "CourseTreeController/getTreeSourse.action?treeid=" + treeid,
            async: false,
            success: function (data) {
                testLayPageData = data;

                iconName=data.icon;

                var state = ""

                if (data.status == 0) {
                    state = "禁用";
                } else {
                    state = "启用";
                }
                var html = '<tr><td>' +
                    '<div class="layui-form"><div class="layui-form-item"><div class="layui-input-block" style="margin-left: 0px;"><input id="subjectTree" value="' +
                    '' + data.treeName + '' +
                    '"type="text" name="title" lay-verify="title" autocomplete="off"  class="layui-input"></div></div></div>'+
                    /*'' + data.treeName + '' +*/
                    '</td><td >' +
                    /*'<img src="file:///C|/fakepath/wlop13.jpg">'+*/
                    '<img src="'+stra+'/'+data.icon+''+'">'+
                    '</td><td >' +

                    '<div class="layui-form"><div class="layui-form-item"><div class="layui-input-block" style="margin-left: 0px;"><select id="treeStyle" name="interest" lay-filter="aihao">';
                if(data.style=="0"){
                    html+='<option value="0" selected="selected">模型库</option>'+
                        '<option value="1">场景库</option>'+
                        '<option value="2">题库</option>'+
                        '<option value="3">考试</option>'+
                        '<option value="4">资源类</option>'
                }else if(data.style=="1"){
                    html+='<option value="0" >模型库</option>'+
                        '<option value="1" selected="selected">场景库</option>'+
                        '<option value="2">题库</option>'+
                        '<option value="3">考试</option>'+
                        '<option value="4">资源类</option>'
                }else if(data.style=="2"){
                    html+='<option value="0">模型库</option>'+
                        '<option value="1">场景库</option>'+
                        '<option value="2" selected="selected">题库</option>'+
                        '<option value="3">考试</option>'+
                        '<option value="4">资源类</option>'
                }
                else if(data.style=="3"){
                    html+='<option value="0">模型库</option>'+
                        '<option value="1">场景库</option>'+
                        '<option value="2">题库</option>'+
                        '<option value="3" selected="selected">考试</option>'+
                        '<option value="4">资源类</option>'
                }
                else if(data.style=="4"){
                    html+='<option value="0">模型库</option>'+
                        '<option value="1">场景库</option>'+
                        '<option value="2">题库</option>'+
                        '<option value="3">考试</option>'+
                        '<option value="4" selected="selected">资源类</option>'
                }

                html +='</select></div></div></div></td><td> <div class="layui-form"> <div class="layui-form-item"> <div class="layui-input-block" style="margin-left: 0px;"> <select id="treeStatus" name="interest" lay-filter="aihao">';
                if (data.status =="0") {
                    console.log("0")
                    html += '<option value="0" selected="selected">启用</option><option value="1" >禁用</option>';
                } else if(data.status =="1"){
                    console.log("1")
                    html += '<option value="0" >禁用</option><option value="1" selected="selected">启用</option>';
                }
                html += '</select> </div> </div> </div> </td>' +
                    '<td>'+
                    '<div class="layui-form">'+
                    '<div class="layui-form-item">'+
                    '<input type="file" id="fileupload" multiple class="btn btn-default" onchange="changefile()"  name="fileupload" style="display:none" />'+
                    '<div class="layui-input-block" style="margin-left: 0px;">'+
                    '<input type="text" id="brosweFile" class="btn btn-default" readonly style="width:50%" />'+
                    '<input type="button" class="layui-btn" style="background:linear-gradient(337deg,rgba(92,205,177,1) 0%,rgba(92,205,178,1) 0%,rgba(89,208,207,1) 100%);" onclick="$(\'#fileupload\').click()" value="浏览" id="brosweevent" />'+
                    '</div> </div> </div> ' +
                        '<img id="BorrowerPhotoPreview" src="" style="width:100px;" />'+
                    '</td>'+
                    '</tr>';
                //document.getElementById('test3').innerHTML = html;
                $("#test3").html(html)

                form.render();
                $("#BorrowerPhotoPreview").hide();
            }
        });

        $("#fileupload").change(function () {
            $("#BorrowerPhotoPreview").show();
            Preview(this,"BorrowerPhotoPreview") }
            );

        function Preview(pointer,ImgId) {
            var $file = $(pointer);
            var fileObj = $file[0];
            var windowURL = window.URL || window.webkitURL;
            var dataURL;
            var $img = $("#" + ImgId);

            if (fileObj && fileObj.files && fileObj.files[0]) {
                dataURL = windowURL.createObjectURL(fileObj.files[0]);
                $img.attr('src', dataURL);
            } else {
                dataURL = $file.val();

                var imgObj = $img;
                // 两个坑:
                // 1、在设置filter属性时，元素必须已经存在在DOM树中，动态创建的Node，也需要在设置属性前加入到DOM中，先设置属性在加入，无效；
                // 2、src属性需要像下面的方式添加，上面的两种方式添加，无效；
                imgObj.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
                imgObj.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = dataURL;

            }

        }

//提交添加科目树
       window.submitTree= function () {
           var subjectTree1=$("#subjectTree").val();
           var treeStyle1=$("#treeStyle").val();
           var treeStatus1=$("#treeStatus").val();
           var subjectid=$(window.parent.document).find("#subject").val();
           var tid=getQueryString("treeid");
           console.log(tid)

           //添加文件
           var brosweFile=$("#brosweFile").val();
           var File1 = $("#fileupload")[0].files[0];
           var data= new FormData;

           if(File1==undefined){
               layer.msg("未上传文件")
               data.append("file",null);
           }else {
               data.append("file",File1);
           }


           data.append("subjectTree",subjectTree1);
           data.append("treeStyle",treeStyle1);
           data.append("treeStatus",treeStatus1);
           data.append("iconName",iconName);
           data.append("treeId",tid);


           console.log(subjectTree1,treeStyle1,treeStatus1,tid,File1);
           /*data:data,
            contentType:false,
            processData:false,*/
           if(tid!=null){
               console.log(data)
               /*$.ajax({
                url:houtaiurl+"CourseTreeController/updateTree.action",
                type:"POST",
                data:{subjectTree:subjectTree1,treeStyle:treeStyle1,treeStatus:treeStatus1,treeId:tid},
                success:function(res){
                window.parent.location.reload();
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
                }
                });*/

               if(File1==undefined){
                   $.ajax({
                       url:houtaiurl+"CourseTreeController/updateTreeNoFile.action",
                       type:"POST",
                       data:{subjectTree:subjectTree1,treeStyle:treeStyle1,treeStatus:treeStatus1,treeId:tid,iconName:iconName},
                       success:function(res){
                           window.parent.location.reload();
                           var index = parent.layer.getFrameIndex(window.name);
                           parent.layer.close(index);
                       }
                   });
               }else {
                   $.ajax({
                       type:"POST",
                       url:houtaiurl+"CourseTreeController/updateTree.action",
                       data:data,
                       contentType:false,
                       processData:false,
                       success:function(data){
                           window.parent.location.reload();
                           var index = parent.layer.getFrameIndex(window.name);
                           parent.layer.close(index);
                       }
                   });
               }
           }else{

               /*$.ajax({
                url:houtaiurl+"CourseTreeController/submitTree.action",
                type:"POST",
                data:{ subjectId:subjectid,subjectTree:subjectTree1,treeStyle:treeStyle1,treeStatus:treeStatus1},
                success:function(res){
                window.parent.location.reload();
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
                }
                });*/
           }
       }
    });

    function changefile(){
        var file = $("#fileupload").val();
        $("#brosweFile").val(file);
    }
    function getQueryString(name) {
        var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
        var r = window.location.search.substr(1).match(reg);
        if (r != null) {
            return unescape(r[2]);
        }
        return null;
    }
</script>